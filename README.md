[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)
[![DOI](https://img.shields.io/badge/DOI-10.1080%2F02640414.2024.2379697-blue)](https://doi.org/10.1080/02640414.2024.2379697)
[![Sample Data](https://img.shields.io/badge/sample_data-included-brightgreen.svg)](sample_data.csv)
[![Example Output](https://img.shields.io/badge/example_output-included-blue.svg)](turnover_model_results_20251114_155537)

# xTurnover: Expected Turnover Model for Football Pass Analysis

A machine learning pipeline that predicts the probability of
turnovers in football passes using mixed-effects logistic regression
with cross-validation. This implementation is based on the methodology
published in the *Journal of Sports Sciences* and provides an automated
system for calculating Expected Pass Turnover (xTurnover) metrics in football
analytics.

**"Predicting turnovers in football using spatial and contextual data:
An expected turnover model"**\
*Journal of Sports Sciences*, 2024\
DOI: 10.1080/02640414.2024.2379697

ðŸ”— [Link to Paper](https://www.tandfonline.com/doi/full/10.1080/02640414.2024.2379697)

## Data Requirements

**Before using this model, you must ensure your dataset contains all
required variables.** Some features require preprocessing from
positional data and cannot be generated by this modeling
pipeline alone.


### Required Preprocessing Steps

1.  **Positional Feature Engineering**: This repository includes a transparent and fully documented workflow for constructing positional features from StatsBomb 360 freeze-frames (2020/21 Premier League). The full methodologyâ€”including directional teammate options, pressure radii, coordinate scaling, and join logicâ€”is described here:

ðŸ‘‰ [Positional Feature Engineering](docs/positional_features.md)

This ensures reproducibility and matches the feature-engineering approach described by Peters et al. in the original xTurnover research.

![Positional Features](figures/Positional_Features.png)

2.  **Data Structure Compliance**: Your dataset must contain all
    variables listed in the "Model Inputs" section.
3.  **Variable Naming**: Column names must match exactly as specified.


## Data Requirements

**Ensure your dataset contains all required variables**. Feature preprocessing is required for positional, spatial, and contextual metrics.  

### Required Features

| Category | Variables |
|----------|-----------|
| Basic Event Data | `turnover_count`, `player.name`, `match_id`, `position_group` |
| Spatial Features | `x`, `y`, `x_end`, `y_end`, `distance_ball_moved`, `ball_movement_speed`, `percent_distance`, `pass.angle` |
| Contextual Features | `play_pattern.name`, `pass.type.name` |
| Pressing Features | `pressing_count_1`, `pressing_count_2`, `pressing_count_3` |
| Teammate Orientation | `right_option`, `front_option`, `left_option`, `back_option` |
| Metadata Variables | `team.name`, `x_end`, `y_end` |

### Feature Explanation
| Feature | Definition | Type | Unit |
|--------|------------|------|------|
| Ball Carrier X Co-ordinate | The x co-ordinate of the pass origin. | Event | Geometric Co-Ordinates (Statsbomb pitches are between 0 - 120 for x and between 0 - 80 for y) |
| Ball Carrier Y Co-ordinate | The y co-ordinate of the pass origin. | Event | Geometric Co-Ordinates (Statsbomb pitches are between 0 - 120 for x and between 0 - 80 for y) |
| Ball Movement Speed | The speed of the pass, taken as the distance travelled divided by the time taken to get to its destination. | Event | Metres per second (m/s) |
| Closest Defender | The distance in metres the closest opposition player is to the ball. | Event | Metres (m) |
| Distance Ball Moved | The distance in metres that the ball moved. | Event | Metres (m) |
| Pass Angle | The angle in radians of the pass, calculated clockwise from 0 representing straight ahead, to Ï€. | Event | Radians (rad) |
| Pass Type Name | Passes were labelled to be from one touch pass from an interception or from a loose ball recovery. The remaining passes were labelled as normal. | Event | Name |
| Percentage Increase in Distance Towards Goal (Ball Progression) | The percentage increase in distance the ball moved towards the centre of the opposition goal. | Event | Percentage (%) |
| Play Pattern Name | The phase of play relevant to the pass event including: throw-in, kick-off, goal kick, free kick, counter attack, corner kick. All remaining play patterns were labelled as regular play. | Event | Name |
| Three Pressure Radii | The number of opposition players independently present within three radii of varying length surrounding the ball carrier. | Positional | Count (n) |
| Unmarked Teammates | Teammates that had no opponent player within 2 metres, across four different directions (options), were considered as unmarked. | Positional | Binary (1 = marked, 0 = unmarked) |

### Additional Metadata Features Required for Subsequent Plotting
| Feature | Definition | Type | Unit |
|--------|------------|------|------|
| Team Name| The name of the possession team | Event | Name |
| Pass X End Location | The x co-ordinate of the pass end location. | Event | Geometric Co-Ordinates (Statsbomb pitches are between 0 - 120 for x and between 0 - 80 for y) |
| Pass Y End Location | The y co-ordinate of the pass end location. | Event | Geometric Co-Ordinates (Statsbomb pitches are between 0 - 120 for x and between 0 - 80 for y) |

**Note:** Sample dataset provided: [sample_data.csv](sample_data.csv)

In addition, there is a sample output folder: [turnover_model_results_20251114_155537/](turnover_model_results).

## ðŸ”§ Data Preprocessing Requirements

### Step 1: Positional Data Processing

-   Calculate pressing variables ( radii)
-   Calculate orientation variables (directional quadrant availability)

### Step 2: Data Validation

R required columns check:

    required_columns <- c(
      "turnover_count", "x", "y", "distance_ball_moved", "ball_movement_speed",
      "percent_distance", "pass.angle", "pressing_count_1", "pressing_count_2", 
      "pressing_count_3", "play_pattern.name", "pass.type.name",
      "right_option", "front_option", "left_option", "back_option",
      "player.name", "match_id", "position_group"
    )

## ðŸš€ Quick Start

### Prerequisites

    install.packages(c("lme4", "dplyr", "pROC"))

### Command Line Execution

    chmod +x run_turnover_model.sh
    ./run_turnover_model.sh your_prepared_data.csv

### R Interactive Usage

    source("cross_validate_turnover_model.R")
    data <- read.csv("your_prepared_data.csv")
    cv_results <- cross_validate_turnover_model(
      data = data,
      outcome_var = "turnover_count",
      k_folds = 5,
      seed = 123,
      verbose = TRUE
    )


## ðŸ“ Generated Outputs

-   `dataset_with_xTurnover.csv`
-   `model_summary_statistics.csv`
-   `fold_details.csv`
-   `confusion_matrix.csv`
-   `all_predictions.csv`
-   `model_report.txt`
-   `complete_cv_results.rds`

------------------------------------------------------------------------

# ðŸ” Example Research Workflow

## 1. **Data Preparation**

Ensure your dataset meets the paper's specifications and includes all
required preprocessing (pressing, orientation, spatial features).

------------------------------------------------------------------------

## 2. **Model Execution**

``` bash
./run_turnover_model.sh your_sample_data.csv
```

------------------------------------------------------------------------

## 3. **Results Analysis**

-   Review `model_report.txt` for performance summary.
-   Analyze `dataset_with_xTurnover.csv` for insights.
-   Use statistical tests to validate empirical findings.

------------------------------------------------------------------------

## 4. **Research Extension (R Example)**

``` r
# Load results for further analysis
results <- readRDS("complete_cv_results.rds")

# Analyze player-specific patterns
player_analysis <- results$xTurnover_dataset %>%
  group_by(player.name) %>%
  summarise(
    avg_xTurnover = mean(xTurnover, na.rm = TRUE),
    actual_turnover_rate = mean(turnover_count),
    decision_quality = actual_turnover_rate - avg_xTurnover
  )
```

---

# ðŸ“Š Plot Outputs

## ðŸ›  Expected Pass Turnover Plot per Team

This script produces a bar plot showing **expected turnovers per 100 passes**, facetted by player **position group**, for a specific team.  

### Script: `team_turnover_plot.R`

### Usage in R

```r
source("team_turnover_plot.R")

team_turnover_plot(
  data = subset_data,
  team = "Team_34",
  min_passes = 30
)
```

### Output

- Saves a PNG in the folder `pressing_target_plots/` (created automatically if missing)  
- Example output:

![Expected Turnovers per Player](figures/example_team_turnover_plot.png)

---

## ðŸ›  High-Risk Pass Clustering

This script identifies **high-risk passes** for a team and performs **k-means clustering** on their start and end coordinates.

### Script: `high_risk_pass_analysis.R`

### Usage in R

```r
source("high_risk_pass_analysis.R")

result <- analyse_high_risk_passes(
    data = subset_data,
    team = "Team_34",
    data_provider = "statsbomb",
    risk_column = "risk_category",
    cluster_count = 6
)
```

### Command-Line Usage

```bash
Rscript high_risk_pass_analysis.R \
  --data sample_data.csv \
  --team "Team_34" \
  --clusters 6 \
  --output high_risk_plot.png \
  --clusterout cluster_data.csv \
  --kmodel kmeans_model.rds
```

### Output

- PNG plot of high-risk passes with clusters  
- Clustered pass data CSV  
- K-means model saved as RDS  
- Output is stored in `high_risk_passes_output/` (auto-created if missing)  

Example plot:  

![High-Risk Pass Clusters](figures/example_high_risk_pass_plot.png)

---

## ðŸš€ Quick Start

1. Prepare your dataset including all required features.
2. Run `team_turnover_plot.R` for expected turnover visualisation per team.
3. Run `high_risk_pass_analysis.R` for high-risk pass clustering analysis.
4. Inspect output PNGs and CSVs.

---

## âš™ Customisation

### team_turnover_plot.R

- `team` â€” team name filter (required)  
- `min_passes` â€” minimum passes per player (default 30)  

### high_risk_pass_analysis.R

- `team` â€” team name filter (required)  
- `risk_column` â€” risk classification column (default `"risk_category"`)  
- `cluster_count` â€” number of k-means clusters (default 6)  
- `data_provider` â€” pitch dimensions (`statsbomb`, `opta`, `wyscout`, etc.)  

---


# ðŸ“š Citation

### **If using the methodology, cite:**

    @article{xTurnover2024,
      title={Predicting turnovers in football using spatial and contextual data: An expected turnover model},
      author={[Author Names]},
      journal={Journal of Sports Sciences},
      year={2024},
      doi={10.1080/02640414.2024.2379697},
      url={https://www.tandfonline.com/doi/epdf/10.1080/02640414.2024.2379697}
    }

### **If using the software implementation, cite:**

    @software{xTurnover_implementation,
      title={xTurnover: Expected Turnover Model Implementation},
      author={[Your Name]},
      year={2024},
      url={https://github.com/[your-repo]},
      note={Implementation of methodology from Journal of Sports Sciences}
    }

------------------------------------------------------------------------

# ðŸ¤ Contributing

We welcome extensions, replications, and methodological improvements.

1.  Fork the repository

2.  Create a feature branch:

    ``` bash
    git checkout -b feature/AmazingFeature
    ```

3.  Test your changes with sample data

4.  Commit:

    ``` bash
    git commit -m "Add some AmazingFeature"
    ```

5.  Push:

    ``` bash
    git push origin feature/AmazingFeature
    ```

6.  Open a Pull Request

------------------------------------------------------------------------

# ðŸ“„ License

This project is distributed under the **MIT License**. See `LICENSE` for
details.

------------------------------------------------------------------------

# ðŸ“§ Contact


### **Technical Support**

-   Check `model_report.txt` for detailed model diagnostics.
-   Ensure all required variables are present in your dataset.
-   Open an issue with sample data + error logs.

------------------------------------------------------------------------

# ðŸ† Acknowledgments

This implementation builds upon peer-reviewed research published in the
*Journal of Sports Sciences*.

We acknowledge the authors, reviewers, and editorial team for advancing
football analytics research.

**Research Note:**
Model performance may vary across leagues, seasons, and
contexts (you must validate on your own dataset).
